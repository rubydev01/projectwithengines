# Creating engines with RSPEC inside a Ruby on Rails project

```
$ rails plugin new engine_name --mountable
```

***Mountable or full?***
- The --mountable option tells the generator that you want to create a 'mountable' and namespace-isolated engine (This prevents constants name collision, between the code of the host app and the engine)

- The --full option tells the generator that you want to create an engine, including a skeleton structure that provides the following

***Other options***
- The --dummy-path, sets the location of 'dummy' app generated by Rails for unit test purposes

- The --skip-test, instructs generator to not scaffold tests, it is useful if you prefer to use another test framework over Minitest. In my case, I am going to configurate RSPEC. Other way to do this is using -T

- The --database, configures database adapter which will be used. It is the best to set it, to the same as the one used by the application from which we want to extract an engine

- The --skip-git, prevents new git repository initialization. You can create the git repository initialization from the beginning but also you can skipt this option and work with this engine in a separate branch until you create other repository for that engine

## Engine 1 (First example)

```
$ rails plugin new engine1 --mountable
```

### If you want to add Rspec to an existing engine:
1. Create a temporary engine to build the dummy app

```
$ rails plugin new same_engine_name --full --dummy-path=spec/dummy -T
```

2. Copy the `spec/` directory to your current engine's root path

```
$ cd same_engine_name
```

```
$ cp -r spec PATH_TO/engine_name/
```
***Continue with the Rspec initialization section***

## Engine 2 (Second example)

```
$ rails plugin new engine2 --mountable --dummy-path=spec/dummy --skip-test --skip-git
```

## Engine 3 (Third example)

```
$ rails plugin new engine3 --mountable --dummy-path=spec/dummy --skip-test --databse=postgresql
```

## RSpec and FactoryBot initialization
1. Add this code in the `gemspec` file

```ruby
# engine_name/engine_name.gemspec

Gem::Specification.new do |spec|  
  ....
  spec.test_files = Dir["spec/**/*"]            

  spec.add_development_dependency 'dotenv-rails'
  spec.add_development_dependency 'factory_bot_rails'
  spec.add_development_dependency 'rspec-rails'
end
```

2. Add this code in the `engine.rb` file

```ruby
# engine_name/lib/engine_name/engine.rb

class Engine < ::Rails::Engine
  ...
  config.generators do |generators|
    generators.test_framework :rspec
  end
end
```

3. Install RSPEC

```
$ cd my_parent_app/engine_name
```
```
$ bundle install
```
```
$ rails g rspec:install
```

4. Run specs to be sure that everything is ok

```
$ rspec spec
```

## Creating a scaffold in the engine

```
$ cd my_parent_app/engine_name
```
```
$ rails g scaffold Player name:string
```
```
$ rails db:migrate
```
***The migrations are created inside the engine, but you also need to run the migrations in the pattern app... we are going to see how we can do that in the next section***

## Pattern app

#### Add the engine in the gemfile

```
$ gem 'engine_name', path: 'engine_name'
```
Using the first example:
```
$ gem 'engine1', path: 'engine1'
```

Then execute
```
$ bundle install
```

#### Add the engine in the route file

```
$ mount Engine_name::Engine, at: '/engine_name'
```

Using the first example:
```
$ mount Engine1::Engine, at: '/engine1'
```

#### Run the migrations
Using the first example:
```
$ rails engine1:install:migrations
```

You are going to see this message:
***Copied migration 20210318203741_create_engine1_players.engine1.rb from engine1***

```
$ rails db:migrate
```

OR if you want to run the migration for a specific engine
```
$ rails db:migrate SCOPE=engine1 
```

#### Run the rails console
```
rails c
```

Using the first example:
```
> Engine1::Player.all
```

## Run the specs of the engine

```
$ cd my_parent_app/engine_name
```

1. If you tried to do `rspec spec` you are going to see an error:

```
Failure/Error: require File.expand_path('../config/environment', __dir__)
LoadError:
  cannot load such file -- /home/ljimenez/projectwithengines/engine_name/config/environment
```

So, you need to modify the `rails_helper` file
```ruby
# engine_name/spec/rails_helper.rb

# require File.expand_path('../config/environment', __dir__)
require File.expand_path('../dummy/config/environment', __FILE__)
```

2. Add `require factory_bot_rails` in the `rails_helper.rb` file

```ruby
# engine_name/spec/rails_helper.rb

require 'spec_helper'
ENV['RAILS_ENV'] ||= 'test'

require File.expand_path('dummy/config/environment', __dir__)

require 'rspec/rails'

require 'factory_bot_rails'
```

## Run the specs again in the engine. Do yo see issues with the routing specs?
```
$ rspec spec
```

- Add: routes { MyEngine::Engine.routes }
- Add `engine_name`: route_to(controller: 'engine_name/companies'...

Using the second example:
```ruby
# spec/routing/engine2/companies_routing_spec.rb

module Engine2
  RSpec.describe CompaniesController, type: :routing do
    routes { Engine2::Engine.routes }

    describe 'routing' do
      it 'routes to #index' do
        expect(get: '/companies')
          .to route_to(controller: 'engine_name/companies', action: 'index')
      end
    end
  end
end
```

## Creating a factory and model spec inside the Engine
Using the second example:

```ruby
# engine_name/spec/factories/engine_name/companies.rb

FactoryBot.define do
  factory :company, class: Engine2::Company do
    name { 'MyString' }
  end
end
```

```ruby
# engine_name/spec/models/engine_name/company_spec.rb

module Engine2
  RSpec.describe Company, type: :model do
    describe 'validations' do
      it 'is not valid without name' do
        company = FactoryBot.build(:company, name: nil)
        expect(company).not_to be_valid
      end
    end
  end
end
```
```
$ rspec spec
```

#### Run the server
```
rails s
```

Using the first example:
```
http://localhost:3000/engine1/players
```

## Some error with the assets?
***Assets not precompiled inside engine***

Add this code in the `engine.rb` file

```ruby
# engine_name/lib/engine_name/engine.rb

class Engine < ::Rails::Engine
  ...
  initializer 'engine_name.assets.precompile' do |app|
    app.config.assets.precompile << 'engine_name_manifest.js'
  end
end
```
```
rails s
```
